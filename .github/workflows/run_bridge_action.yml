# Run arbitrary command on Bridge runner with optional denylist and artifact upload
#
# Triggered by `inspire bridge exec ...` via workflow_dispatch.

name: Bridge Action Exec
run-name: Bridge action ${{ inputs.request_id }}

on:
  workflow_dispatch:
    inputs:
      raw_command:
        description: 'Raw shell command to execute (bash -lc)'
        required: true
        type: string
      denylist:
        description: 'Optional comma or newline-separated denylist patterns'
        required: false
        type: string
        default: ''
      target_dir:
        description: 'Target directory on the shared filesystem'
        required: true
        type: string
      artifact_paths:
        description: 'Optional newline-separated paths (relative to target_dir) to upload as artifact'
        required: false
        type: string
        default: ''
      request_id:
        description: 'Unique request id used to name the artifact and run'
        required: true
        type: string

jobs:
  exec:
    runs-on: [self-hosted, qizhi-self-hosted]
    timeout-minutes: 30
    permissions:
      actions: write
      contents: read

    env:
      TARGET_DIR: ${{ inputs.target_dir }}
      RAW_COMMAND: ${{ inputs.raw_command }}
      DENYLIST: ${{ inputs.denylist }}
      ARTIFACT_PATHS: ${{ inputs.artifact_paths }}
      REQUEST_ID: ${{ inputs.request_id }}

    steps:
      - name: Validate inputs
        run: |
          set -euo pipefail

          if [ -z "$TARGET_DIR" ]; then
            echo "target_dir input is required" >&2
            exit 1
          fi

          if [ ! -d "$TARGET_DIR" ]; then
            echo "Target directory does not exist: $TARGET_DIR" >&2
            exit 1
          fi

          if [ -z "$RAW_COMMAND" ]; then
            echo "raw_command input is required" >&2
            exit 1
          fi

      - name: Apply denylist
        run: |
          set -euo pipefail

          # Normalize denylist: split on newlines and commas
          DENY_ENTRIES=$(printf "%s" "$DENYLIST" | tr ',' '\n' | sed '/^$/d') || true

          if [ -n "$DENY_ENTRIES" ]; then
            echo "Denylist entries (glob patterns):" >&2
            printf '%s\n' "$DENY_ENTRIES" >&2

            while IFS= read -r pattern; do
              if [ -z "$pattern" ]; then
                continue
              fi
              # Use bash extended glob via case statement
              # shellcheck disable=SC2254
              case "$RAW_COMMAND" in
                $pattern)
                  echo "Command blocked by denylist pattern: $pattern" >&2
                  exit 1
                  ;;
              esac
            done <<< "$DENY_ENTRIES"
          else
            echo "No denylist provided; proceeding (warning)" >&2
          fi

      - name: Run command
        working-directory: ${{ env.TARGET_DIR }}
        run: |
          set -euo pipefail
          echo "Running command in $PWD"
          echo "Command: $RAW_COMMAND"

          # Capture stdout and stderr to log file while also displaying
          mkdir -p /tmp/bridge-artifacts
          bash -lc "$RAW_COMMAND" 2>&1 | tee /tmp/bridge-artifacts/output.log
          exit ${PIPESTATUS[0]}

      - name: Collect artifact paths
        if: ${{ env.ARTIFACT_PATHS != '' }}
        run: |
          set -euo pipefail
          mkdir -p /tmp/bridge-artifacts

          # Read ARTIFACT_PATHS as newline list
          while IFS= read -r relpath; do
            if [ -z "$relpath" ]; then
              continue
            fi
            src="$TARGET_DIR/$relpath"
            if [ ! -e "$src" ]; then
              echo "Warning: artifact path not found, skipping: $relpath" >&2
              continue
            fi
            dest_dir="/tmp/bridge-artifacts/$(dirname "$relpath")"
            mkdir -p "$dest_dir"
            cp -a "$src" "$dest_dir/"
          done <<< "$ARTIFACT_PATHS"

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bridge-action-${{ env.REQUEST_ID }}
          path: /tmp/bridge-artifacts/
          retention-days: 1

      - name: Summary
        run: |
          echo "Bridge action completed"
          echo "Request ID: $REQUEST_ID"
          echo "Target dir: $TARGET_DIR"
          if [ -n "$ARTIFACT_PATHS" ]; then
            echo "Artifacts requested:"
            printf '%s\n' "$ARTIFACT_PATHS"
          else
            echo "No artifacts requested"
          fi
