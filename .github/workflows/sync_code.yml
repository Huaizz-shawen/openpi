# Sync Code to Shared Filesystem
#
# This workflow runs on the Bridge self-hosted runner. It is triggered
# via the GitHub Actions API (workflow_dispatch) by the `inspire sync`
# command running on a laptop. It syncs the specified branch to the
# shared filesystem that the Inspire training platform can access.

name: Sync Code

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to sync'
        required: true
        type: string
      commit_sha:
        description: 'Expected commit SHA (for verification)'
        required: false
        type: string
      force:
        description: 'Force sync (git reset --hard), discarding local changes'
        required: false
        type: string
        default: 'false'
      target_dir:
        description: 'Target directory on the shared filesystem'
        required: true
        type: string

jobs:
  sync-code:
    runs-on: [self-hosted, qizhi-self-hosted]
    timeout-minutes: 10
    permissions:
      contents: read

    env:
      SYNC_TARGET_DIR: ${{ inputs.target_dir }}

    steps:
      - name: Prepare target directory
        env:
          REPO_URL: "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
        run: |
          if [ -z "$SYNC_TARGET_DIR" ]; then
            echo "Error: target_dir input is required" >&2
            exit 1
          fi

          if [ ! -d "$SYNC_TARGET_DIR" ]; then
            echo "Target directory does not exist: $SYNC_TARGET_DIR"
            echo "Creating target directory..."
            mkdir -p "$SYNC_TARGET_DIR"
            echo "Created: $SYNC_TARGET_DIR"
          fi

          if [ ! -d "$SYNC_TARGET_DIR/.git" ]; then
            echo "No git repository found in $SYNC_TARGET_DIR"

            if [ -n "$(ls -A "$SYNC_TARGET_DIR")" ]; then
              echo "Directory is not empty; cannot initialize repository automatically." >&2
              exit 1
            fi

            echo "Cloning ${{ github.repository }} into $SYNC_TARGET_DIR..."
            git clone "$REPO_URL" "$SYNC_TARGET_DIR"
          fi

          echo "Target directory: $SYNC_TARGET_DIR"
          echo "Branch to sync: ${{ inputs.branch }}"
          echo "Force mode: ${{ inputs.force }}"

      - name: Check for local changes on Bridge
        id: check_changes
        run: |
          cd "$SYNC_TARGET_DIR"

          # Check for uncommitted changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo ""
            echo "=== Local Changes Detected on Bridge ==="
            git status --short
            echo ""
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Sync code
        env:
          GIT_ASKPASS: echo
          GIT_TERMINAL_PROMPT: "0"
        run: |
          cd "$SYNC_TARGET_DIR"
          BRANCH="${{ inputs.branch }}"
          FORCE="${{ inputs.force }}"
          HAS_CHANGES="${{ steps.check_changes.outputs.has_changes }}"

          echo "Current directory: $(pwd)"
          echo "Git status before sync:"
          git status --short || true

          # Configure git to use token authentication
          git config --local credential.helper ""
          git remote set-url origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"

          # Fetch the latest from origin
          echo ""
          echo "Fetching from origin..."
          git fetch origin

          # Check if branch exists on remote
          if ! git ls-remote --exit-code --heads origin "$BRANCH" > /dev/null 2>&1; then
            echo "Error: Branch '$BRANCH' does not exist on remote" >&2
            exit 1
          fi

          # Try normal sync first
          sync_failed=false
          error_message=""

          # Handle both existing and new branches
          if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
            # Branch exists locally
            git checkout "$BRANCH" 2>/dev/null || {
              error_message="Failed to checkout branch '$BRANCH'. Working tree may have conflicts."
              sync_failed=true
            }

            if [ "$sync_failed" = "false" ]; then
              git pull origin "$BRANCH" --ff-only 2>/dev/null || {
                error_message="Failed to pull branch '$BRANCH'. Cannot fast-forward - local branch has diverged from remote."
                sync_failed=true
              }
            fi
          else
            # Branch doesn't exist locally, create from remote
            git checkout -b "$BRANCH" "origin/$BRANCH" 2>/dev/null || \
            git checkout --track "origin/$BRANCH" 2>/dev/null || {
              error_message="Failed to checkout new branch '$BRANCH' from remote."
              sync_failed=true
            }
          fi

          # Handle sync failure
          if [ "$sync_failed" = "true" ]; then
            echo ""
            echo "=== Sync Error ===" >&2
            echo "$error_message" >&2

            if [ "$HAS_CHANGES" = "true" ]; then
              echo "" >&2
              echo "Local changes on Bridge:" >&2
              git status --short >&2
            fi

            if [ "$FORCE" = "true" ]; then
              echo ""
              echo "Force mode enabled. Resetting to origin/$BRANCH..."
              git checkout "$BRANCH" 2>/dev/null || git checkout -B "$BRANCH" "origin/$BRANCH"
              git reset --hard "origin/$BRANCH"
              echo "Force sync completed."
            else
              echo "" >&2
              echo "To force sync and discard local changes, run:" >&2
              echo "  inspire sync --force" >&2
              exit 1
            fi
          fi

          # Verify the commit if SHA was provided
          EXPECTED_SHA="${{ inputs.commit_sha }}"
          ACTUAL_SHA=$(git rev-parse HEAD)

          echo ""
          echo "=== Sync Complete ==="
          echo "Branch: $BRANCH"
          echo "Commit: $ACTUAL_SHA"
          echo "Message: $(git log -1 --format='%s')"

          if [ -n "$EXPECTED_SHA" ] && [ "$ACTUAL_SHA" != "$EXPECTED_SHA" ]; then
            echo ""
            echo "Warning: Commit SHA mismatch"
            echo "  Expected: $EXPECTED_SHA"
            echo "  Actual:   $ACTUAL_SHA"
            echo "This may happen if the branch was updated after pushing."
          fi

      - name: Show sync result
        run: |
          cd "$SYNC_TARGET_DIR"
          echo ""
          echo "=== Repository Status ==="
          echo "Directory: $SYNC_TARGET_DIR"
          echo "Branch: $(git branch --show-current)"
          echo "Commit: $(git rev-parse --short HEAD)"
          echo "Last commit:"
          git log -1 --oneline
